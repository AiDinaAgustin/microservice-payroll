services:
  api-router:
    image: alpine:latest
    command: sh -c "while true; do sleep 3600; done"
    networks:
      - traefik-public
    deploy:
      replicas: 1
      labels:
        - "traefik.enable=true"
        # Main router
        - "traefik.http.routers.api-main.rule=Host(`api.karsa.site`)"
        - "traefik.http.routers.api-main.entrypoints=websecure"
        - "traefik.http.routers.api-main.tls.certresolver=myresolver"
        - "traefik.http.routers.api-main.service=api-lb"

        # Define service with servers (use internal service names)
        - "traefik.http.services.api-lb.loadbalancer.passhostheader=true"

        # Use internal Docker service names with HTTP
        - "traefik.http.services.api-lb.loadbalancer.servers.0.url=http://gateway-1:5000"
        - "traefik.http.services.api-lb.loadbalancer.servers.0.weight=3"
        - "traefik.http.services.api-lb.loadbalancer.servers.1.url=http://gateway-2:5000"
        - "traefik.http.services.api-lb.loadbalancer.servers.1.weight=1"

        # Health check configuration
        - "traefik.http.services.api-lb.loadbalancer.healthcheck.path=/health"
        - "traefik.http.services.api-lb.loadbalancer.healthcheck.interval=5s"
        - "traefik.http.services.api-lb.loadbalancer.healthcheck.timeout=3s"

networks:
  traefik-public:
    external: true
    name: tascrum_traefik-public